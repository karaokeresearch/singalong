<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="ntpclient.js"></script>
		<script src="howler.js"></script>
		<script src="hammer.js"></script>
		<script src="gyro.js"></script>
		<script src="cookies.js"></script>
		<script src="jquery-2.1.1.min.js"></script>
		<script src="playalongclient.js"></script>

		<script>

			var lagOverride;
			var playQueue=[];
			var one = new Howl({
				urls: ['/one.wav']
			});
			var two = new Howl({
				urls: ['/two.wav']
			});
			var three = new Howl({
				urls: ['/three.wav']
			});
			var four = new Howl({
				urls: ['/four.wav']
			});

			var socket = io.connect();
			ntp.init(socket);

			var whatIsDate= function(){
			console.log("whatisDate called");
			return ntp.serverTime();
			};


			setInterval(function () { //demo: add items to the queue once a second
				playQueue.push([ntp.serverTime() + (1000-(ntp.serverTime()%1000)+1000),1])
					console.log([ntp.serverTime() + (1000-(ntp.serverTime()%1000)+1000),1]);
			},5000);


			setInterval(function () { //the queue
				document.getElementById("report").innerHTML=  "Server time: <br>" + ntp.serverTime(); //what time the server thinks it is

				while ((playQueue.length>0) && (playQueue[0][0]>ntp.serverTime()===false)){ //clear up any cruft or past entries
					playQueue.shift();
				}

				while ((playQueue.length>0) &&(playQueue[0][0] - ntp.serverTime() <500)){//although it's tested every 250 ms, we can schedule up to 500 away.
					var whenTimeout= (playQueue[0][0] - ntp.serverTime()); 
					setTimeout(function (){ //what happens to items in the queue
						var count=(Math.round(ntp.serverTime()/1000)%4 )+1;
						if (count===1){
							one.play();
						}
						if (count===2){
							two.play();
						}
						if (count===3){
							three.play();
						}
						if (count===4){
							four.play();
						}
						//console.log(count);
						//document.getElementById("count").innerHTML= count;
						document.getElementById("count").innerHTML= "Date.now=" +whatIsDate();
					//	}, (1000-(ntp.serverTime()%1000)));
					}, whenTimeout);
					console.log(ntp.serverTime() + " now, scheduled for " +whenTimeout);
					playQueue.shift();
				}
			},250);

			var updateLagReadout= function(){
				lagOverride = parseInt( document.getElementById("latency").value);
				if (lagOverride===0){
					document.getElementById("latency").value = Cookies.get('latency');
					lagOverride = (parseInt(Cookies.get('latency')) || 0);
				}
				document.getElementById("lag").innerHTML = "Lag override: " + lagOverride;
				Cookies.set('latency', lagOverride, {expires: '01/01/3000'});
			};

			updateLagReadout();





		</script>
	</head>
	<body>
		<center><pre>&lt;--- Speed up                           Slow down --&gt;</pre></center>
		<form>
			<input oninput="updateLagReadout()" type="range" name="latency" value=0 id="latency" min="-200" max="200" style="width:100%">
		</form>
		<div><span id="report"></span> </div>
		<div><span id="count"></span></div>
		<div><span id="lag"></span></div>

	</body>
</html>