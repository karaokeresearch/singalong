<html>
	<head>

		<title>Motion Instrument</title>
	</head>
	<body bgcolor="pink">
		<script type="text/javascript" src="../cookies.js"></script>
		<script type="text/javascript" src="../gyro.js"></script>
		<script type="text/javascript" src="../howler.js"></script>
		<script type="text/javascript" src="../ntpclient.js"></script>
		<script type="text/javascript" src="../teoria.js"></script>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>

		<script type="text/javascript" src="../playalong.js"></script>


		<script>
			
			var socket = io.connect();
			ntp.init(socket);      
			
			
			gyro.frequency=50;

			var lagOverride=-200;
			var playQueue=[];
			var loudness;
			var trueLoudness;
			var tone1;
			var tone2;
			var tone3;
			var tone4;

			var baseTone=[];
			
			//load WAV samples
			for (i=1; i<=24; i++){
			var wavurl=i+ '.wav';
				baseTone[i] = new Howl({
					urls: [wavurl],
					autoplay: true,
					loop: true,
					volume: 0
				});
			}





			var changeChord = function (whichChord){
				var chordNotes =[];
				var chord=teoria.chord(whichChord);
				for (i=0; i< chord.notes().length; i++) {
					chordNotes.push((chord.notes()[i].key()+4)%24);
				}
				for (i=0; i< chord.notes().length; i++) {
					chordNotes.push(((chord.notes()[i].key()+16)%24));
				}
				chordNotes.sort(function(a, b){return a-b});

				var tempVol1=0;
				var tempVol2=0;
				var tempVol3=0;
				var tempVol4=0;


				if (tone1){
					tempVol1=tone1.volume();
				tone1.volume(0);}
				if (tone2){
					tempVol2=tone2.volume();
				tone2.volume(0);}
				if (tone3){
					tempVol3=tone3.volume();
				tone3.volume(0);}
				if (tone4){
					tempVol4=tone4.volume();
				tone4.volume(0);}

				tone1 = baseTone[chordNotes[0]+1];
				tone2 = baseTone[chordNotes[1]+1];
				tone3 = baseTone[chordNotes[2]+1];
				tone4 = baseTone[chordNotes[3]+1];

				tone1.volume(tempVol1);
				tone2.volume(tempVol2);
				tone3.volume(tempVol3);
				tone4.volume(tempVol4);

			}

			changeChord('D');









			var decreaseInterval=0.035;

			gyro.startTracking(function(o) {
				combinedXYZ=(Math.abs(o.x) + Math.abs(o.y) + Math.abs(o.z));
				combinedXYZnoABS=(o.x + o.y + o.z);
				trueLoudness = (combinedXYZ/12)-0.1;
				if (trueLoudness<loudness){
					loudness=loudness-decreaseInterval;
				}else{
					loudness=trueLoudness;
				}
				//loudness = 0.5;
				loudness=(combinedXYZ/12)-0.1;

				if (loudness <0) {loudness=0}
				var whichLoud;


				if (o.beta>90 || o.beta<-90){    //180 / -180 center point //face down
					if (tone4.volume() <=((Math.abs(o.beta)-90)/90)*(loudness)){
						tone4.volume(((Math.abs(o.beta)-90)/90)*(loudness));
						}else{tone4.volume(tone4.volume()-decreaseInterval)}
					}else{
						tone4.volume(tone4.volume()-decreaseInterval)
					}

					if (o.beta>0 && o.beta<180){ //90 center point
						if (tone1.volume() <= (Math.abs(Math.abs(o.beta-90)-90)/90)*(loudness)){
							tone1.volume((Math.abs(Math.abs(o.beta-90)-90)/90)*(loudness)) //straight up
							}else{tone1.volume(tone1.volume()-decreaseInterval)}

						}else{
							tone1.volume(tone1.volume()-decreaseInterval)
						}

						if (o.beta>-90 && o.beta<90){ //0 center point
							if (tone2.volume() <= (Math.abs(Math.abs(o.beta)-90)/90)*(loudness)){
								tone2.volume((Math.abs(Math.abs(o.beta)-90)/90)*(loudness)) //face up
								}else{tone2.volume(tone2.volume()-decreaseInterval)}

							}else{
								tone2.volume(tone2.volume()-decreaseInterval)
							}

							if (o.beta>-180 && o.beta<-0){ // -90 center point
								if (tone3.volume() <= (Math.abs(Math.abs(o.beta+90)-90)/90)*(loudness)){
									tone3.volume((Math.abs(Math.abs(o.beta+90)-90)/90)*(loudness)) //upside down
									}else{tone3.volume(tone3.volume()-decreaseInterval)}

								}else{
									tone3.volume(tone3.volume()-decreaseInterval)
								}

								if (tone4.volume() <decreaseInterval){tone4.volume(0);}
								if (tone3.volume() <decreaseInterval){tone3.volume(0);}
								if (tone2.volume() <decreaseInterval){tone2.volume(0);}
								if (tone1.volume() <decreaseInterval){tone1.volume(0);}


							});



	socket.on('bnext', function (data) { //what's the next chord and when
	    //console.log(data.nextChord + ", " + data.nextChange);
	    
			playQueue.push([parseInt(data.nextChange)+lagOverride,data.nextChord])
					document.getElementById("queue").innerHTML = "queuing " + data.nextChord + " in " + ((data.nextChange-ntp.serverTime()) +lagOverride);

		document.getElementById("queue").innerHTML += "<br>offset=" +ntp.offset();

	});



			setInterval(function () { //the queue

		//		console.log("queue: " + playQueue[0][0]);
		//		console.log("stime: " + ntp.serverTime());
			
				while ((playQueue.length>0) && (playQueue[0][0]>ntp.serverTime()===false)){ //clear up any cruft or past entries
					playQueue.shift();
				}
				

				while ((playQueue.length>0) &&(playQueue[0][0] - ntp.serverTime() <500)){//although it's tested every 250 ms, we can schedule up to 500ms away.
					//console.log(playQueue[0][0] + "--- "  + playQueue[0][1]);
					//document.getElementById("play").innerHTML = "<br>playing " +whatsnext + " in " + (playQueue[0][0] - ntp.serverTime()) + "ms";
					
					(function (){							
						var whatsnext=playQueue[0][1];
						setTimeout(function (){
							changeChord(whatsnext);
							document.getElementById("actual").innerHTML = "Actual: " + whatsnext;
						}, (playQueue[0][0] - ntp.serverTime()));
					}());
			playQueue.shift();
				}
			},250);
















						</script>
						<div id="actual" style="font-size:20"></div>

						<div id="queue" style="font-size:20"></div>
						<div id="play" style="font-size:20"></div>
						
						<BR>

					</body>
				</html>
